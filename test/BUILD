load("@bazel_skylib//rules:expand_template.bzl", "expand_template")
load("@llvm-project//llvm:lit_test.bzl", "lit_test", "package_path")

expand_template(
    name = "lit_site_cfg_py",
    testonly = True,
    out = "lit.site.cfg.py",
    substitutions = {
        "@LIT_SITE_CFG_IN_HEADER@": "# Autogenerated, do not edit.",
        "\"@TCP_SOURCE_DIR@\"": "os.path.join(os.environ['TEST_SRCDIR'], 'tensor_compute_primitives_ws')",
        "\"@TCP_BINARY_DIR@\"": "os.path.join(os.environ['TEST_SRCDIR'], 'tensor_compute_primitives_ws')",
        "\"@LLVM_TOOLS_DIR@\"": "os.path.join(os.environ['TEST_SRCDIR'], 'llvm-project', 'llvm')",
        # All disabled, but required to substituted because they are not in quotes.
        "@MLIR_ENABLE_BINDINGS_PYTHON@": "0",
        "@TORCH_MLIR_ENABLE_JIT_IR_IMPORTER@": "0",
    },
    template = "lit.site.cfg.py.in",
)

# Common data used by most lit tests.
filegroup(
    name = "lit_data",
    testonly = True,
    data = [
        "lit.cfg.py",
        "lit.site.cfg.py",
        "@llvm-project//llvm:FileCheck",
        "@llvm-project//llvm:count",
        "@llvm-project//llvm:not",
    ],
)

[
    lit_test(
        name = "%s.test" % src,
        srcs = [src],
        data = [
            "//:tcp-opt",
            "//test:lit_data",
        ],
    )
    for src in glob(["**/*.mlir"])
]
